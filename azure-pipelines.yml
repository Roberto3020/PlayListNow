trigger:
- main

pool:
  name: MyAgent
  demands:
    - agent.os -equals Linux

name: 'MyAgentPipeline'

variables:
  system.debug: true  # Logs detallados para SonarCloud

steps:

# ============================================
# 1. SonarCloud - PREPARE (Backend .NET)
# ============================================
- task: SonarCloudPrepare@1
  displayName: 'Prepare SonarCloud analysis (.NET backend)'
  inputs:
    SonarCloud: 'SonarCloudService'  # tu service connection
    organization: 'rorcasita30'
    scannerMode: 'MSBuild'
    configMode: 'manual'
    projectKey: 'rorcasita30-backend'
    projectName: 'RORCASITA30 Backend'
    extraProperties: |
      sonar.host.url=https://sonarcloud.io
      sonar.verbose=true

# ============================================
# 2. Restore .NET
# ============================================
- task: DotNetCoreCLI@2
  displayName: 'Restore backend'
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

# ============================================
# 3. Build .NET
# ============================================
- task: DotNetCoreCLI@2
  displayName: 'Build backend'
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration Release'

# ============================================
# 4. SonarCloud ANALYZE (Backend .NET)
# ============================================
- task: SonarCloudAnalyze@1
  displayName: 'Run SonarCloud analysis (.NET backend)'

# ============================================
# 5. Build Angular
# ============================================
- task: CmdLine@2
  displayName: "Build Angular frontend"
  inputs:
    workingDirectory: "$(Build.SourcesDirectory)/WebUI"
    script: |
      npm install
      npm run build --prod

# ============================================
# 6. SonarCloud - OPTIONAL ANALYSIS (Frontend Angular)
# ============================================
- task: SonarCloudPrepare@1
  displayName: 'Prepare SonarCloud analysis (Angular frontend)'
  inputs:
    SonarCloud: 'SonarCloudService'
    organization: 'rorcasita30'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: 'rorcasita30-frontend'
    cliProjectName: 'RORCASITA30 Frontend'
    extraProperties: |
      sonar.sources=.
      sonar.host.url=https://sonarcloud.io
      sonar.javascript.lcov.reportPaths=WebUI/coverage/lcov.info

- task: SonarCloudAnalyze@1
  displayName: 'Run SonarCloud analysis (Angular frontend)'

# ============================================
# 7. SonarCloud PUBLISH
# ============================================
- task: SonarCloudPublish@1
  displayName: 'Publish SonarCloud Quality Gate'
  inputs:
    pollingTimeoutSec: '600'

# ============================================
# 8. Docker Login
# ============================================
- task: Docker@2
  displayName: 'Login to Docker Hub'
  inputs:
    command: 'login'
    containerRegistry: 'DockerHubConnection'

# ============================================
# 9. Docker Build & Push Backend
# ============================================
- task: Docker@2
  displayName: 'Build & Push backend image'
  inputs:
    command: 'buildAndPush'
    containerRegistry: 'DockerHubConnection'
    repository: 'rorcasita30/playlist-backend'
    dockerfile: 'WebApi/Dockerfile'
    tags: |
      latest

# ============================================
# 10. Docker Build & Push Frontend
# ============================================
- task: Docker@2
  displayName: 'Build & Push frontend image'
  inputs:
    command: 'buildAndPush'
    containerRegistry: 'DockerHubConnection'
    repository: 'rorcasita30/playlist-frontend'
    dockerfile: 'WebUI/Dockerfile'
    tags: |
      latest

# ============================================
# 11. Deploy to microk8s (solo Linux)
# ============================================
- script: |
    echo "âš  microk8s deployment solo disponible en Linux"
  displayName: 'Deploy to microk8s'
